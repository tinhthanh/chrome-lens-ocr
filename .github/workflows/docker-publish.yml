# T√™n c·ªßa to√†n b·ªô quy tr√¨nh, s·∫Ω hi·ªÉn th·ªã tr√™n tab Actions c·ªßa GitHub
name: Build, Push, and Deploy Docker Image

# K√≠ch ho·∫°t quy tr√¨nh khi c√≥ code m·ªõi ƒë∆∞·ª£c ƒë·∫©y l√™n nh√°nh "main"
on:
  push:
    branches: [ "main" ]
  # T√πy ch·ªçn: Th√™m d√≤ng n√†y ƒë·ªÉ c√≥ th·ªÉ ch·∫°y th·ªß c√¥ng t·ª´ giao di·ªán GitHub
  workflow_dispatch:

# ƒê·ªãnh nghƒ©a c√°c c√¥ng vi·ªác (jobs) s·∫Ω ƒë∆∞·ª£c th·ª±c thi
jobs:
  # === JOB 1: BUILD V√Ä PUSH IMAGE L√äN DOCKER HUB ===
  build-and-push:
    name: Build and Push to Docker Hub
    runs-on: ubuntu-latest
    steps:
      # B∆∞·ªõc 1: L·∫•y m√£ ngu·ªìn t·ª´ repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # B∆∞·ªõc 2: C√†i ƒë·∫∑t QEMU ƒë·ªÉ gi·∫£ l·∫≠p c√°c ki·∫øn tr√∫c CPU kh√°c (c·∫ßn cho build ƒëa n·ªÅn t·∫£ng)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      # B∆∞·ªõc 3: C√†i ƒë·∫∑t Docker Buildx, c√¥ng c·ª• build m·∫°nh m·∫Ω c·ªßa Docker
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # B∆∞·ªõc 4: ƒêƒÉng nh·∫≠p v√†o Docker Hub s·ª≠ d·ª•ng secrets
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # B∆∞·ªõc 5: Build v√† push image ƒëa n·ªÅn t·∫£ng (amd64 v√† arm64)
      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          # K√≠ch ho·∫°t t√≠nh nƒÉng build cho nhi·ªÅu n·ªÅn t·∫£ng
          platforms: linux/amd64,linux/arm64
          # ƒê·∫©y image l√™n registry sau khi build th√†nh c√¥ng
          push: true
          # G·∫Øn c√°c tag cho image. ·ªû ƒë√¢y l√† "latest" v√† m√£ hash c·ªßa commit
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/vg-ocr-api:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/vg-ocr-api:${{ github.sha }}

  # === JOB 2: DEPLOY IMAGE L√äN SERVER ===
  deploy:
    name: Deploy to Production Server
    needs: build-and-push
    runs-on: ubuntu-latest
    
    # M·ªöI: ƒê·ªãnh nghƒ©a bi·∫øn m√¥i tr∆∞·ªùng cho to√†n b·ªô job n√†y
    env:
      # ƒê·ªçc to√†n b·ªô n·ªôi dung c·ªßa file docker-compose.prod.yml v√† l∆∞u v√†o bi·∫øn DOCKER_COMPOSE_CONTENT
      DOCKER_COMPOSE_CONTENT: ${{ toJSON(fromJSON(file('docker-compose.prod.yml'))) }}

    steps:
      # B∆∞·ªõc 1: Checkout code ƒë·ªÉ c√≥ th·ªÉ truy c·∫≠p file docker-compose.prod.yml
      - name: Checkout repository
        uses: actions/checkout@v3

      # B∆∞·ªõc 2: SSH v√†o server v√† th·ª±c thi c√°c l·ªánh deploy
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          
          # Script ƒë√£ ƒë∆∞·ª£c r√∫t g·ªçn v√† th√¥ng minh h∆°n r·∫•t nhi·ªÅu
          script: |
            echo "üöÄ Starting deployment..."
            
            # 1. ƒê·ªãnh nghƒ©a bi·∫øn cho ƒë∆∞·ªùng d·∫´n
            TARGET_DIR="/home/vetgo/cicd/app_services/repo/vg-ocr-api"
            
            # 2. ƒê·∫£m b·∫£o th∆∞ m·ª•c t·ªìn t·∫°i
            echo "Ensuring deployment directory exists at $TARGET_DIR"
            mkdir -p $TARGET_DIR
            
            # 3. M·ªöI & QUAN TR·ªåNG: Ghi n·ªôi dung file t·ª´ bi·∫øn m√¥i tr∆∞·ªùng l√™n server
            # Kh√¥ng c·∫ßn hardcode n·ªØa, n·ªôi dung ƒë∆∞·ª£c l·∫•y tr·ª±c ti·∫øp t·ª´ m√£ ngu·ªìn!
            echo "Writing docker-compose.prod.yml from source code..."
            echo "${{ env.DOCKER_COMPOSE_CONTENT }}" > $TARGET_DIR/docker-compose.prod.yml
            
            # 4. Di chuy·ªÉn v√†o th∆∞ m·ª•c deploy
            cd $TARGET_DIR
            
            # 5. Export bi·∫øn m√¥i tr∆∞·ªùng DOCKERHUB_USERNAME ƒë·ªÉ Docker Compose s·ª≠ d·ª•ng
            export DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
            
            # 6. K√©o image m·ªõi nh·∫•t
            echo " pulling latest image from DockerHub..."
            docker-compose -f docker-compose.prod.yml pull
            
            # 7. Kh·ªüi ƒë·ªông l·∫°i service
            echo " starting containers with the new image..."
            docker-compose -f docker-compose.prod.yml up -d --remove-orphans
            
            # 8. D·ªçn d·∫πp
            echo " cleaning up old images..."
            docker image prune -f
            
            echo "‚úÖ Deployment finished successfully!"