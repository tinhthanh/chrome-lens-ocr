# TÃªn cá»§a toÃ n bá»™ quy trÃ¬nh
name: Build, Push, and Deploy Docker Image

# KÃ­ch hoáº¡t quy trÃ¬nh
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # === JOB 1: BUILD VÃ€ PUSH IMAGE LÃŠN DOCKER HUB (KHÃ”NG THAY Äá»”I) ===
  build-and-push:
    name: Build and Push to Docker Hub
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/vg-ocr-api:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/vg-ocr-api:${{ github.sha }}

  # === JOB 2: DEPLOY IMAGE LÃŠN SERVER (Sá»¬ Dá»¤NG PHÆ¯Æ NG PHÃP BASE64 - Ráº¤T á»”N Äá»ŠNH) ===
  deploy:
    name: Deploy to Production Server
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      # BÆ°á»›c 1: Checkout code Ä‘á»ƒ cÃ³ thá»ƒ truy cáº­p file docker-compose.prod.yml
      - name: Checkout repository
        uses: actions/checkout@v3

      # BÆ¯á»šC 2: Äá»c vÃ  MÃƒ HÃ“A Base64 ná»™i dung file, sau Ä‘Ã³ lÆ°u vÃ o output
      # PhÆ°Æ¡ng phÃ¡p nÃ y biáº¿n file nhiá»u dÃ²ng thÃ nh má»™t chuá»—i an toÃ n duy nháº¥t.
      - name: Read and Base64 Encode docker-compose file
        id: read_file
        run: |
          # DÃ¹ng cÃº phÃ¡p NAME=VALUE Ä‘Æ¡n giáº£n vÃ  Ä‘Ã¡ng tin cáº­y.
          # base64 -w0 Ä‘áº£m báº£o khÃ´ng cÃ³ ngáº¯t dÃ²ng trong chuá»—i mÃ£ hÃ³a.
          echo "content=$(base64 -w0 docker-compose.prod.yml)" >> $GITHUB_OUTPUT

      # BÆ°á»›c 3: SSH vÃ o server vÃ  sá»­ dá»¥ng output Ä‘Ã£ Ä‘Æ°á»£c mÃ£ hÃ³a
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          
          script: |
            echo "ðŸš€ Starting deployment..."
            
            TARGET_DIR="/home/vetgo/cicd/app_services/repo/vg-ocr-api"
            
            echo "Ensuring deployment directory exists at $TARGET_DIR"
            mkdir -p $TARGET_DIR
            
            # GIáº¢I MÃƒ chuá»—i base64 vÃ  ghi láº¡i ná»™i dung gá»‘c vÃ o file trÃªn server.
            echo "Writing docker-compose.prod.yml from source code..."
            # Dáº¥u | (pipe) sáº½ gá»­i chuá»—i base64 Ä‘áº¿n lá»‡nh base64 -d Ä‘á»ƒ giáº£i mÃ£.
            echo "${{ steps.read_file.outputs.content }}" | base64 -d > $TARGET_DIR/docker-compose.prod.yml
            
            cd $TARGET_DIR
            
            export DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
            
            echo " pulling latest image from DockerHub..."
            docker-compose -f docker-compose.prod.yml pull
            
            echo " starting containers with the new image..."
            docker-compose -f docker-compose.prod.yml up -d --remove-orphans
            
            echo " cleaning up old images..."
            docker image prune -f
            
            echo "âœ… Deployment finished successfully!"