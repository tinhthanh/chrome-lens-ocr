# TÃªn cá»§a toÃ n bá»™ quy trÃ¬nh
name: Build, Push, and Deploy Docker Image

# KÃ­ch hoáº¡t quy trÃ¬nh
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

# Chá»‰ cáº§n thay Ä‘á»•i giÃ¡ trá»‹ á»Ÿ Ä‘Ã¢y khi báº¡n deploy má»™t service má»›i.
env:
  SERVICE_NAME: vg-ocr-api

jobs:
  # === JOB 1: BUILD VÃ€ PUSH IMAGE LÃŠN DOCKER HUB ===
  build-and-push:
    name: Build and Push to Docker Hub
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.SERVICE_NAME }}:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }}

  # === JOB 2: DEPLOY IMAGE LÃŠN SERVER ===
  deploy:
    name: Deploy to Production Server
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Read and Base64 Encode docker-compose file
        id: read_file
        run: |
          echo "content=$(base64 -w0 docker-compose.prod.yml)" >> $GITHUB_OUTPUT

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          
          script: |
            # Dá»«ng script ngay láº­p tá»©c náº¿u cÃ³ báº¥t ká»³ lá»‡nh nÃ o tháº¥t báº¡i
            set -e

            echo "ðŸš€ Starting deployment for service: ${{ env.SERVICE_NAME }}"
            
            # Tá»° Äá»˜NG PHÃT HIá»†N Lá»†NH DOCKER COMPOSE
            # Kiá»ƒm tra xem 'docker compose' (V2) cÃ³ tá»“n táº¡i khÃ´ng
            if docker compose version &>/dev/null; then
              COMPOSE_CMD="docker compose"
              echo "âœ… Docker Compose V2 detected. Using 'docker compose' command."
            # Náº¿u khÃ´ng, kiá»ƒm tra 'docker-compose' (V1)
            elif docker-compose --version &>/dev/null; then
              COMPOSE_CMD="docker-compose"
              echo "âš ï¸ Docker Compose V2 not found. Falling back to V1 'docker-compose' command."
            # Náº¿u cáº£ hai Ä‘á»u khÃ´ng cÃ³, bÃ¡o lá»—i vÃ  thoÃ¡t
            else
              echo "âŒ ERROR: Neither 'docker compose' (V2) nor 'docker-compose' (V1) are installed on the server."
              exit 1
            fi

            TARGET_DIR="/home/vetgo/cicd/app_services/repo/${{ env.SERVICE_NAME }}"
            
            echo "Ensuring deployment directory exists at $TARGET_DIR"
            mkdir -p $TARGET_DIR
            
            echo "Writing docker-compose.prod.yml from source code..."
            echo "${{ steps.read_file.outputs.content }}" | base64 -d > $TARGET_DIR/docker-compose.prod.yml
            
            cd $TARGET_DIR
            
            echo "Creating .env file for Docker Compose..."
            cat << EOF > .env
            DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
            SERVICE_NAME=${{ env.SERVICE_NAME }}
            EOF
            
            echo " pulling latest image from DockerHub..."
            # Sá»­ dá»¥ng biáº¿n COMPOSE_CMD Ä‘Ã£ Ä‘Æ°á»£c phÃ¡t hiá»‡n á»Ÿ trÃªn
            $COMPOSE_CMD -f docker-compose.prod.yml pull
            
            echo " starting containers with the new image..."
            # Sá»­ dá»¥ng biáº¿n COMPOSE_CMD, thÃªm --env-file Ä‘á»ƒ tÆ°Æ¡ng thÃ­ch tá»‘t hÆ¡n vá»›i V1
            $COMPOSE_CMD --env-file .env -f docker-compose.prod.yml up -d --remove-orphans
            
            echo " cleaning up old images..."
            docker image prune -f
            
            echo "âœ… Deployment finished successfully!"