# T√™n c·ªßa to√†n b·ªô quy tr√¨nh
name: Build, Push, and Deploy Docker Image

# K√≠ch ho·∫°t quy tr√¨nh
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # === JOB 1: BUILD V√Ä PUSH IMAGE L√äN DOCKER HUB (KH√îNG THAY ƒê·ªîI) ===
  build-and-push:
    name: Build and Push to Docker Hub
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/vg-ocr-api:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/vg-ocr-api:${{ github.sha }}

  # === JOB 2: DEPLOY IMAGE L√äN SERVER (S·ª¨ D·ª§NG STEP OUTPUTS - C√ÅCH L√ÄM ƒê√öNG) ===
  deploy:
    name: Deploy to Production Server
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      # B∆∞·ªõc 1: Checkout code ƒë·ªÉ c√≥ th·ªÉ truy c·∫≠p file docker-compose.prod.yml
      - name: Checkout repository
        uses: actions/checkout@v3

      # B∆Ø·ªöC 2: ƒê·ªçc n·ªôi dung file v√† l∆∞u v√†o m·ªôt STEP OUTPUT
      # ƒê√¢y l√† ph∆∞∆°ng ph√°p ch√≠nh x√°c ƒë·ªÉ truy·ªÅn d·ªØ li·ªáu nhi·ªÅu d√≤ng gi·ªØa c√°c b∆∞·ªõc.
      - name: Read docker-compose.prod.yml content to an output variable
        id: read_file # ƒê·∫∑t ID cho b∆∞·ªõc n√†y ƒë·ªÉ c√≥ th·ªÉ tham chi·∫øu ƒë·∫øn output c·ªßa n√≥
        run: |
          # S·ª≠ d·ª•ng c√∫ ph√°p GITHUB_OUTPUT ƒë·ªÉ t·∫°o m·ªôt output t√™n l√† 'content'
          echo "content<<EOF" >> $GITHUB_OUTPUT
          cat docker-compose.prod.yml >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # B∆∞·ªõc 3: SSH v√†o server v√† s·ª≠ d·ª•ng output t·ª´ b∆∞·ªõc tr∆∞·ªõc
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          
          script: |
            echo "üöÄ Starting deployment..."
            
            TARGET_DIR="/home/vetgo/cicd/app_services/repo/vg-ocr-api"
            
            echo "Ensuring deployment directory exists at $TARGET_DIR"
            mkdir -p $TARGET_DIR
            
            # Ghi n·ªôi dung file t·ª´ output c·ªßa b∆∞·ªõc 'read_file'
            echo "Writing docker-compose.prod.yml from source code..."
            # Tham chi·∫øu ƒë·∫øn output b·∫±ng c√∫ ph√°p: steps.<step_id>.outputs.<output_name>
            echo "${{ steps.read_file.outputs.content }}" > $TARGET_DIR/docker-compose.prod.yml
            
            cd $TARGET_DIR
            
            export DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
            
            echo " pulling latest image from DockerHub..."
            docker-compose -f docker-compose.prod.yml pull
            
            echo " starting containers with the new image..."
            docker-compose -f docker-compose.prod.yml up -d --remove-orphans
            
            echo " cleaning up old images..."
            docker image prune -f
            
            echo "‚úÖ Deployment finished successfully!"