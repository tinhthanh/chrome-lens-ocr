# T√™n c·ªßa to√†n b·ªô quy tr√¨nh
name: Build, Push, and Deploy Docker Image

# K√≠ch ho·∫°t quy tr√¨nh
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # === JOB 1: BUILD V√Ä PUSH IMAGE L√äN DOCKER HUB (KH√îNG THAY ƒê·ªîI) ===
  build-and-push:
    name: Build and Push to Docker Hub
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/vg-ocr-api:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/vg-ocr-api:${{ github.sha }}

  # === JOB 2: DEPLOY IMAGE L√äN SERVER (PHI√äN B·∫¢N ƒê√É S·ª¨A L·ªñI) ===
  deploy:
    name: Deploy to Production Server
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      # B∆∞·ªõc 1: Checkout code ƒë·ªÉ c√≥ th·ªÉ truy c·∫≠p file docker-compose.prod.yml
      - name: Checkout repository
        uses: actions/checkout@v3

      # B∆Ø·ªöC M·ªöI: ƒê·ªçc n·ªôi dung file v√† l∆∞u v√†o bi·∫øn m√¥i tr∆∞·ªùng
      # ƒê√¢y l√† c√°ch l√†m ƒë√∫ng ƒë·ªÉ x·ª≠ l√Ω file trong workflow
      - name: Read docker-compose.prod.yml content
        id: read_file
        run: |
          # D√πng c√∫ ph√°p ƒë·∫∑c bi·ªát c·ªßa GitHub Actions ƒë·ªÉ t·∫°o bi·∫øn m√¥i tr∆∞·ªùng DOCKER_COMPOSE_CONTENT
          # cho c√°c b∆∞·ªõc ti·∫øp theo. K·ªπ thu·∫≠t "here document" (<<EOF) ƒë·∫£m b·∫£o n·ªôi dung nhi·ªÅu d√≤ng ƒë∆∞·ª£c gi·ªØ nguy√™n.
          echo "DOCKER_COMPOSE_CONTENT<<EOF" >> $GITHUB_ENV
          cat docker-compose.prod.yml >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # B∆∞·ªõc 3: SSH v√†o server v√† th·ª±c thi c√°c l·ªánh deploy
      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          
          # Script kh√¥ng thay ƒë·ªïi, n√≥ s·∫Ω s·ª≠ d·ª•ng bi·∫øn m√¥i tr∆∞·ªùng ƒë√£ ƒë∆∞·ª£c t·∫°o ·ªü b∆∞·ªõc tr√™n
          script: |
            echo "üöÄ Starting deployment..."
            
            TARGET_DIR="/home/vetgo/cicd/app_services/repo/vg-ocr-api"
            
            echo "Ensuring deployment directory exists at $TARGET_DIR"
            mkdir -p $TARGET_DIR
            
            # Ghi n·ªôi dung file t·ª´ bi·∫øn m√¥i tr∆∞·ªùng ƒë√£ ƒë∆∞·ª£c ƒë·ªçc ·ªü b∆∞·ªõc tr∆∞·ªõc
            echo "Writing docker-compose.prod.yml from source code..."
            # Bi·∫øn DOCKER_COMPOSE_CONTENT gi·ªù ƒë√£ c√≥ s·∫µn ƒë·ªÉ s·ª≠ d·ª•ng
            echo "$DOCKER_COMPOSE_CONTENT" > $TARGET_DIR/docker-compose.prod.yml
            
            cd $TARGET_DIR
            
            export DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
            
            echo " pulling latest image from DockerHub..."
            docker-compose -f docker-compose.prod.yml pull
            
            echo " starting containers with the new image..."
            docker-compose -f docker-compose.prod.yml up -d --remove-orphans
            
            echo " cleaning up old images..."
            docker image prune -f
            
            echo "‚úÖ Deployment finished successfully!"